<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gd.sakila.mapper.CustomerMapper">
	<select id="selectCustomerTotal"
			parameterType="Map"
			resultType="Integer">
		SELECT
			Count(*)
	FROM customer
		<where>
			<if test="searchWord != null and searchWord !='' ">
				AND name LIKE CONCAT('%',#{searchWord},'%')
			</if>
			<if test="storeId != null and storeId !=''">
				AND store_id = ${storeId}
			</if>
		</where>
	</select>
	
	<select id="selectCustomerList"
			parameterType="Map"
			resultType="Map"> 
		SELECT 
		   customer_id customerId
		   , CONCAT(first_name, ' ' , last_name) name
		   , email
		   , store_id storeId
		   <!-- if 만약에 (조건12~17 , 18 참이면'black', 거짓이면'') VIP칼럼으로 출력 -->
		   <!-- IN연산자 - 괄호 내의 값 중 일치하는 것이 있으면 TRUE -->
		   , if(customer_id IN(SELECT p.customer_id  
		   <!-- customer_id가 IN(페이먼트의 customer_id)랑 같다면 -->
			                     FROM payment p LEFT JOIN rental r ON p.rental_id=r.rental_id JOIN inventory i 
			                     <!--  -->
			                     ON r.inventory_id=i      .inventory_id JOIN film f ON i.film_id=f.film_id 
			                     WHERE DATEDIFF(r.return_date, r.rental_date) > f.rental_duration
			                     GROUP BY p.customer_id
			                     HAVING COUNT(p.customer_id)>=10),
			'BLACK', '') blackList
		   , if(customer_id IN(SELECT p.customer_id
			                     FROM payment AS p
			                     WHERE DATE(p.payment_date) BETWEEN DATE_SUB('2005-06-25', INTERVAL 1 MONTH) AND LAST_DAY('2005-06-25')
			                     GROUP BY customer_id
			                     HAVING SUM(p.amount) > 10
			                     AND COUNT(customer_id) > 5),
			 'VIP','') VIP <!-- 대문자 인걸 깜빡 -->
		FROM customer
		<where>
			<if test="searchWord != null and searchWord !='' ">
				AND name LIKE CONCAT('%',#{searchWord},'%')
			</if>
			<if test="storeId != null and storeId !=''">
				AND store_id = ${storeId}
			</if>
		</where>
		ORDER BY
			customer_id
		LIMIT
			${beginRow}, ${rowPerPage}
		
	</select>
</mapper>